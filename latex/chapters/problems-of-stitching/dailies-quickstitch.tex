\chapter{Dailies Quickstitch}
\pagecolor{white}
\label{chap:30}
\begin{fullwidth}
% \vspace{\baselineskip}

\problem

{\large You need to quickly stitch some source footage with burnt in timecode for a review session but don't know where to start. \par}

You've just finished the \textbf{\nameref{chap:29}} process and organized your source footage onto a hard disk after shooting multiple takes for many scenes. It's now time to sort and label your files into bins. As opposed to the traditional post-production workflow, reviewing your dailies can't happen until your footage is stitched together. Stitching two or more videos together will first require you to organize your files properly.

\solution

{\large AVP + APG. \par}

Most video camera manufacturers are developing built-in functionality to ease the stitching/playback of 360 dailies. If you don't have a \textbf{\nameref{chap:11}} solution, you will have to stitch the videos yourself before previewing dailies. Thanks to Autopano Video Pro (AVP) from Kolor, it's just a few clicks away.

Autopano Video Pro or AVP is the go-to video stitching software and industry standard. It takes at least two videos for the stitching process to occur. Since stitching videos is an intensive task for most of today’s GPUs and CPUs, AVP has a “sister” software. Autopano Giga or APG is the advanced stitching tool for combining multiple images into a panorama. 

To stitch multiple videos into one panoramic video, AVP will extract a frame from each of your videos as a .jpg image. These images will be stitched together based on a selected calibration. You can select a different frame by moving the cursor on the timeline, and AVP will re-extract the newly selected frame from each video stream. After stitching the different images, your panoramic video will be stitched based on the stitch quality of the frame selected. 

\imgA{1}{30/extraction}

When the stitch quality is not perfect throughout the video, use APG to edit the stitch manually with the use of \textbf{\nameref{chap:36}} or \textbf{\nameref{chap:41}}. In APG, you will have the option to auto-update your stitch in AVP by saving your stitch template. The template holds metadata that allows AVP to stitch your videos based on your adjustments in APG.

\tip Before you start stitching, it is best to check the preferences of AVP. Under Blend > set Blending Level to 0, Weighting to ISO Cutting, and under Render Settings > set FPS as original video. Later on, you may also want to add different presets for your renders, helping you speed up your own workflow.

\imgB{.5}{30/blend}{30/rendersettings}

{\large Synchronize. Calibrate. Stitch. \par}

Drag your videos into AVP. All videos must have the same format (mp4 or mov) and same frames per second (FPS). The accuracy of the visual sync between cameras may vary depending on the equipment used, or your \textbf{\nameref{chap:6}}. Ensure all cameras are perfectly synchronized before stitching. Apply "Use Audio to Synchronize" under Synchronization menu, after selecting a frame of your timeline. 

\imgA{1}{30/drag_videos}

Before jumping onto the stitch tab (fourth icon in the AVP header bar), select a range of frames by trimming your timeline at the beginning and end using the blue range selector. Use "I" for IN and "O" for OUT frame with AVP 2.3. Then click on the exact frame you want for the calibration. Don't leave it on the beginning frames. You don't want to confuse AVP by trying to stitch the DP's fingers or face. Save that for later during the fine stitch. 

\imgA{1}{30/rangeselection}

Select a stitching preset using the dropdown. The default preset will auto stitch as GoPro. If you are using different camera lens, check "Lens model" and input the focal length and lens type. For example, enter in 8mm for your focal length and fisheye for type of lens. Press "OK", then click "Stitch" and let AVP do the rest!

\imgB{.5}{30/lensmodel}{30/lens_model_inputs}

Bravo, you have just completed your first quick stitch!

%\clearpage
{\large Re-Orient. Optimize. Render. \par}

When stitched together, your panoramic video may need to be adjusted or rotated. Hold your cursor on the preview area and drag until the horizon is aligned. Don't forget to apply your changes. Press "A" to apply with AVP 2.3.

\imgB{.5}{30/panotomove}{30/panomoved}

Select the Blend icon to better optimize the blending of your videos. For static or landscape shots, try the SMART cutting and you may be impressed by how the quality of the stitch will improve. For most shots, when the camera is moving or if you have moving subjects, ISO cutting is recommended.

Rendering is the last step in the workflow. Every software you use to edit the video or audio of a file will let you export the changes by creating a new video or audio file with the render settings you selected.

Before you start rendering, double check that all your default preferences are correct. Consider the right FPS for the playback solution of your choosing. Even if you shot at 100 FPS or 60 FPS, you will want to output at an FPS that the headsets or video player can handle. 

For example, if you want to upload your 360 video to YouTube or Facebook, the current allowed FPS is 24, 25 or 30. For quick stitches, set the FPS to be same "as original video" under the Render settings. Setting the default preferences will make it easier to batch render.

\imgB{.5}{30/fps25}{30/fpsoriginal}

When you are ready to hit the "render" icon, AVP will bring a pop up of some presets to choose from and show the maximum output size. The maximum output size is the resolution achieved from your 360 camera rig. Depending on the rig you chose, the final resolution after stitching can range from 4K to 12K. Presets are very valuable during stitching and you will want to get familiar with all the choices. When you want to render small files quickly to test and find seams to fix, you can output at a lower resolution such as 2K. You can always check at the bottom of the pop up window what resolution and frame rate the video will render as. For the Gear VR, render your videos at 3840x1920 or 4096x2048 when shooting 4K (1920x960 is SD).

{\large Fine Stitch Rendering. \par}

When rendering your fine stitch, it is highly recommended to render output type as frames, a sequence of uncompressed tiff images at 16 bit color depth. Rendering frames keeps the highest possible resolution of your panorama at the maximum size allowed. There are limitations when you render videos. The bit depth will be between 8 to 10 bit, including the AVI uncompressed option, and there are size limits (for example: H.264 mp4 maximum height at 2304px). Your footage will be running through many processes down the pipeline. From stitching to VFX to editing to color grading, pixels will get distorted down the line. Distortion occurs within the range of 10-16 bits. 

Starting with Autopano, you will want to work on the highest resolution files to minimize distortion of colored pixels and keep the full quality when rendering an 8-10 bit per channel video. Output tiff Frames at 16 bit and no compression in AVP.

\imgA{.65}{30/exportingtiffs}

\tip Removing the alpha channel when exporting tiffs will reduce the size of each tiff. Recommended for large sequences.

Every time you render, you are creating a new file. Stay organized so you know what version each render is. Add a prefix to every file. Use QS for Quickstitch, a version number \_v001 for your tests, and FS for Fine Stitch. When rendering frames, select an output folder with the suffix \_tiff in the name.

\clearpage
{\large Encoding a burnt-in timecode \par}

You can use After Effects, Premiere or any video editing software to encode a timecode or you can do it...the "hard" way aka not really, just the geeky but in reality faster way! \textbf{\nameref{chap:56}}! Don't let the terminal or command lines scare you!

For Mac users, the "drawtext" filter of FFmpeg is only working with a specific FFmpeg binary. Refer to \textbf{\nameref{chap:56}} to install the right binary.

Open the Terminal app on Mac, Command Prompt on PC. Use the basic commands to access the directory where your stitched video is located.

\imgA{1}{30/terminal}

\tip On Mac, if your Finder is opened with your video visible, drag the folder icon into the Terminal window AFTER typing "cd" (e.g. change directory). On PC, click the folder icon to reveal the path, and paste it in your Command prompt after "cd".

Type the exact FFmpeg script for the action you want to perform on the video: embedding a timecode in center of video, at the same frame rate as video.

Run FFmpeg by simply typing "ffmpeg" in the terminal. FFmpeg takes a video in and creates a new video out. Let's tell ffmpeg where and which video you want as input. Just type "-i" and the path/name of your file.

\code{ffmpeg -i video.mp4}

Type the name for the output file. This FFmpeg script doesn't really perform any action besides renaming the output file. If you want to change the extension of the output filename to .mov, FFmpeg will operate a conversion of your video from MP4 to MOV.

\code{ffmpeg -i video.mp4 video\_tc.mp4}

To add any kind of text or timecode on your video, use the filter "drawtext" after calling it via -vf command before the output, such as:

\code{ffmpeg -i video.mp4 -vf "drawtext=" video\_tc.mp4}

Select a monospaced font file from your machine:

\code{fontfile='/Library/Fonts/Arial.ttf':}

Then add the format for the timecode including the frame rate (matching same FPS as video), font size, color, and position on the video:

\code{timecode='00\\:00\\:00;00':r=29.97: fontsize=32: fontcolor=white: x=(w)/2:y=(h)/2}

Note the colons are required between each argument. Put all of this together into one command line:

\code{ffmpeg -i video.mp4 -vf "drawtext=fontfile='/Library/Fonts/Arial.ttf':timecode='00\\:00\\:00;00':r=29.97:fontsize=32:fontcolor=white:x=(w)/2:y=(h)/2" video\_tc.mp4}

Press RETURN after pasting this line into your Terminal and FFmpeg will render the video again with the timecode on it. Good Job!

If you get an FFmpeg error message of "Drop frame is only allowed with 30000/1001 or 60000/1001 FPS" that means your video clip is using a non-drop frame based timebase such as 24/25/30/60 fps. To fix this issue, you will have to change the FFmpeg timecode string value to \code{timecode='00\\:00\\:00\\:00'} and adjust the r=29.97 timecode frame rate setting to match your current video clip's frame rate.

With FFmpeg on Linux the command is:

\code{ffmpeg -i video.mp4 -vf "drawtext=fontfile='/usr/share/fonts/dejavu/DejaVuSans.ttf':timecode='00\\:00\\:00;00':r=29.97:fontsize=32:fontcolor=white:x=(w)/2:y=(h)/2" video\_tc.mp4}

With FFmpeg on Windows the command is: 

\code{ffmpeg -i video.mp4 -vf "drawtext=fontfile='C\\:\\\\Windows\\\\Fonts\\\\arial.ttf': timecode='00\\:00\\:00;00':r=29.97:fontsize=32:fontcolor=white:x=(w)/2:y=(h)/2" video\_tc.mp4}

Note the fontfile path on Windows needs to have each of the directory slashes escaped with a double slash, and the colon in the drive letter needs to be escaped with a slash as well.


\clearpage

\end{fullwidth}
